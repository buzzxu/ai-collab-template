# /sync - 进度同步

> 查看项目进度，验证任务状态与代码实际状态的一致性

---

## 触发条件

用户说：
- "项目进度"
- "同步检查"
- "/sync"
- "/sync --quick"
- "还有什么要做"
- "进度怎么样"

---

## 参数说明

| 参数 | 说明 |
|------|------|
| `--quick` | 快速模式，跳过一致性检查 |

---

## Claude Code 执行流程

### Step 1: 读取所有任务

遍历 `project/tasks/*.yaml`，加载所有任务。

### Step 2: 统计进度

计算各模块和整体进度：

```
Module1:  {completed}/{total} ({percent}%)
Module2:  {completed}/{total} ({percent}%)
──────────────────────────────────────────
Total:    {completed}/{total} ({percent}%)
```

### Step 3: 验证已完成任务 (非 quick 模式)

对每个 `status: completed` 的任务：
1. 重新执行 `done_when` 检查
2. 记录通过/失败状态

### Step 3.5: 验证 session.md 一致性

> **重要**: 检查 `.context/session.md` 与任务文件的一致性

**检查项**:
1. session.md 中提到的 "进行中" 任务是否确实是 `status: in_progress`
2. session.md 中提到的 "待实现" 任务是否确实是 `status: pending`
3. session.md 中的进度数据是否与实际统计匹配

**如发现不一致**:
```
⚠️ session.md 与任务状态不一致:

| 问题 | session.md 声称 | 实际状态 |
|------|-----------------|----------|
| {task-id} | 进行中 | completed |

建议: 运行 `/handoff` 重新生成交接文档
```

### Step 4: 生成报告

```markdown
## 项目进度报告

**生成时间**: {日期时间}

### 整体进度

| 模块 | 完成 | 进行中 | 待开始 | 进度 |
|------|:----:|:------:|:------:|------|
| Module1 | {n} | {n} | {n} | ████░░░░ {percent}% |
| Module2 | {n} | {n} | {n} | ██████░░ {percent}% |

**总进度**: {completed}/{total} ({percent}%)

---

### 当前进行中

| 任务 | 名称 | 负责人 |
|------|------|--------|
{列出 in_progress 任务}

---

### 待审计

| 任务 | 名称 | 审计者 |
|------|------|--------|
{列出待审计任务}

---

### 一致性检查

**任务验收检查**:
{如果所有 completed 任务验证通过}
✅ 所有已完成任务验证通过

{如果有不一致}
⚠️ 发现 {n} 个不一致:

| 任务 | 问题 |
|------|------|
| {id} | {失败的检查项} |

建议: 运行 `/task-reopen {id}` 重新开启

**session.md 一致性检查**:
{如果 session.md 与任务状态一致}
✅ session.md 与任务状态一致

{如果有不一致}
⚠️ session.md 过时:

| 文件声称 | 实际状态 |
|----------|----------|
| {任务} {声称状态} | {实际状态} |

建议: 运行 `/handoff` 重新生成交接文档

---

### 下一步建议

按优先级排序，依赖已满足：

| 优先级 | 任务 | 名称 |
|:------:|------|------|
| P0 | {id} | {name} |
| P1 | {id} | {name} |
```

### Step 5: 可选自动修正

如果发现不一致，询问用户是否自动修正。

---

## SOP (Gemini / Codex / 其他 AI)

### Step 1: 读取任务文件

```bash
cat project/tasks/*.yaml
```

### Step 2: 统计

手动统计各状态数量。

### Step 3: 验证 completed 任务

对每个 completed 任务，执行其 `done_when` 检查。

**file_exists**:
```bash
ls {path} 2>/dev/null && echo "PASS" || echo "FAIL"
```

**content_match**:
```bash
grep -q "{pattern}" {file} && echo "PASS" || echo "FAIL"
```

### Step 4: 输出报告

按上述格式输出进度报告。

---

## 示例

**输入**: `/sync`

**输出**:

```
## 项目进度报告

**生成时间**: 2026-01-17 15:30

### 整体进度

| 模块 | 完成 | 进行中 | 待开始 | 进度 |
|------|:----:|:------:|:------:|------|
| Frontend | 6 | 0 | 11 | ████░░░░░░ 35% |
| Backend | 12 | 0 | 7 | ████████░░ 63% |

**总进度**: 18/30 (60%)

---

### 一致性检查

✅ 所有已完成任务验证通过

---

### 下一步建议

| 优先级 | 任务 | 名称 |
|:------:|------|------|
| P0 | FE-1.5 | 状态管理 |
| P0 | BE-1.9 | 错误处理 |
```
